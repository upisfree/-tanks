(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p={}.hasOwnProperty,q=function(a,b){function c(){this.constructor=a}for(var d in b)p.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};for(b={debug:!0},Array.prototype.remove=function(a){var b,c,d;d=[];for(b in this)c=this[b],d.push(c.i===a.i?this.splice(b,1):void 0);return d},Math.randomInt=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},Math.radiansToDegrees=function(a){return a*(180/Math.PI)},Math.degreesToRadians=function(a){return a*(Math.PI/180)},k=Matter.Vector,k.fromAngle=function(a){return a-=Math.PI/2,{x:Math.cos(a),y:Math.sin(a)}},Matter.RenderPixi.create=function(a){var b,c;return b={controller:Matter.RenderPixi,element:null,canvas:null,options:{width:800,height:600,background:"#fafafa",wireframeBackground:"#222",enabled:!0,wireframes:!0,showSleeping:!0,showDebug:!1,showBroadphase:!1,showBounds:!1,showVelocity:!1,showCollisions:!1,showAxes:!1,showPositions:!1,showAngleIndicator:!1,showIds:!1,showShadows:!1}},c=Matter.Common.extend(b,a),c.context=new PIXI.WebGLRenderer(c.options.width,c.options.height,c.canvas,!1,!0),c.canvas=c.context.view,c.stage=new PIXI.Stage,c.textures={},c.sprites={},c.primitives={},c.spriteBatch=new PIXI.DisplayObjectContainer,c.stage.addChild(c.spriteBatch),Matter.Common.isElement(c.element)?c.element.appendChild(c.canvas):Matter.Common.log('No "render.element" passed, "render.canvas" was not inserted into document.',"warn"),c.canvas.oncontextmenu=c.canvas.onselectstart=function(){return!1},c},Matter.RenderPixi.world=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(h=a.render,j=a.world,f=a.map,d=h.context,i=h.stage,g=h.options,b=Matter.Composite.allBodies(j),c=Matter.Composite.allConstraints(j),k=0,n=f.length;n>k;k++)e=f[k],h.spriteBatch.addChildAt(e.sprite,0);for(l=0,o=b.length;o>l;l++)e=b[l],Matter.RenderPixi.body(a,e);for(m=0,p=c.length;p>m;m++)e=c[m],Matter.RenderPixi.constraint(a,e);return d.render(i)},Matter.RenderPixi.body=function(a,b){var c,d,e,f,g,h,i,j;if(d=a.render,c=b.render,f=d.spriteBatch,c.visible){if(c.tank){for(-1===f.children.indexOf(c.tank)&&f.addChild(c.tank),j=c.tank.children,h=0,i=j.length;i>h;h++)e=j[h],e.position.x=b.position.x,e.position.y=b.position.y;c.tank.children[0].rotation=b.angle}return c.sprite&&c.sprite.texture?(g="b-"+b.id,e=d.sprites[g],e||(e=d.sprites[g]=Matter.RenderPixi._createBodySprite(d,b)),-1===f.children.indexOf(e)&&f.addChild(e),e.position.x=b.position.x,e.position.y=b.position.y,e.rotation=b.angle):void 0}},Matter.RenderPixi._getTexture=function(a,b){var c;return c=a.textures[b],c||(c=a.textures[b]=PIXI.Texture.fromImage(b)),c},Matter.RenderPixi._createBodySprite=function(a,b){var c,d,e,f;return c=b.render,f=c.sprite.texture,e=Matter.RenderPixi._getTexture(a,f),d=new PIXI.Sprite(e),d.anchor.x=.5,d.anchor.y=.5,d},h={step:32},h.sizeByStep={x:Math.round(window.innerWidth/h.step),y:Math.round(window.innerHeight/h.step)},h.size={x:h.sizeByStep.x*h.step,y:h.sizeByStep.y*h.step},f={position:{x:0,y:0}},c=Matter.Engine.create(document.body,{world:{gravity:{x:0,y:0},bounds:{min:{x:-1/0,y:-1/0},max:{x:1/0,y:1/0}}},enableSleeping:!0,render:{controller:Matter.RenderPixi,options:{width:h.size.x,height:h.size.y,wireframes:!1}},map:[]}),d={tanks:{}},a={set:function(a){return c.render.context.offset=new PIXI.Point(a.x,a.y)},followPlayer:function(b){return Matter.Events.on(c,"tick",function(){return a.set({x:h.size.x/2-b.body.position.x,y:h.size.y/2-b.body.position.y})})}},e={Cell:function(){function a(a,b,d,e){this.x=a,this.y=b,this.type=d,this.rotation=null!=e?e:0,this.sprite=new PIXI.Sprite(PIXI.Texture.fromImage("assets/textures/map/"+this.type+".png")),this.sprite.position.x=this.x*h.step+h.step/2,this.sprite.position.y=this.y*h.step+h.step/2,this.sprite.rotation=Math.degreesToRadians(this.rotation),this.sprite.anchor.x=.5,this.sprite.anchor.y=.5,c.map.push(this)}return a}(),generate:function(){var a,b,c,d,f,g;for(g=[],b=d=0,f=h.sizeByStep.x;f>=0?f>=d:d>=f;b=f>=0?++d:--d)g.push(function(){var d,f,g;for(g=[],c=d=0,f=h.sizeByStep.y;f>=0?f>=d:d>=f;c=f>=0?++d:--d)a=Math.randomInt(0,100),g.push(10>a?new e.Cell(b,c,"gravel"):a>10&&20>a?new e.Cell(b,c,"dirt"):a>20&&30>a?new e.Cell(b,c,"grass"):90===a?new e.Cell(b,c,"puddle"):new e.Cell(b,c,"ground"));return g}());return g}},i=function(){function a(a){var b,e,f;this.tank=a,f=k.fromAngle(this.tank.body.turretRotation),b=this.tank.body.position.x+20*f.x,e=this.tank.body.position.y+20*f.y,this.body=Matter.Bodies.rectangle(b,e,7,14,{angle:this.tank.body.turretRotation,friction:1,frictionAir:.1,mass:1e3,render:{sprite:{texture:"assets/textures/tanks/shell.png"}}}),this.body.label="shell-"+this.tank.body.id,Matter.Composite.add(c.world,this.body),Matter.Body.applyForce(this.body,{x:0,y:0},k.mult(f,200)),Matter.Body.applyForce(this.tank.body,{x:0,y:0},k.neg(k.mult(f,50))),Matter.Events.on(c,"collisionStart",function(b){var e,f,g,h,i,j;for(g=b.pairs,j=[],h=0,i=g.length;i>h;h++)if(f=g[h],f.bodyA.label.contains("tank")&&f.bodyB.label.contains("shell")){if(Matter.Composite.remove(c.world,f.bodyB),a=d.tanks[f.bodyA.label.replace(/tank-/,"")],!a)break;e=Math.round(100*f.separation),a.lives-=e,j.push(a.lives<=0?a.destroy():void 0)}else j.push(f.bodyA.label.contains("shell")&&f.bodyB.label.contains("shell")?Matter.Composite.remove(c.world,[f.bodyA,f.bodyA]):void 0);return j})}return a}(),j=function(){function a(a,b,e,f,g){var h,i;this.texture=e,this.width=null!=f?f:25,this.height=null!=g?g:23,this.body=Matter.Bodies.rectangle(a,b,this.width,this.height,{friction:1,frictionAir:.1,mass:1e4,render:{tank:null}}),this.body.label="tank-"+this.body.id,this.body.render.tank=new PIXI.DisplayObjectContainer,h=new PIXI.Sprite(PIXI.Texture.fromImage("assets/textures/tanks/"+this.texture+"/base.png")),h.position={x:a,y:b},h.anchor={x:.5,y:.5},i=new PIXI.Sprite(PIXI.Texture.fromImage("assets/textures/tanks/"+this.texture+"/turret.png")),i.position={x:a,y:b},i.anchor={x:.5,y:.73},this.body.render.tank.addChild(h),this.body.render.tank.addChild(i),Matter.Composite.add(c.world,this.body),d.tanks[this.body.id]=this}return a.prototype.move=function(a){return Matter.Body.applyForce(this.body,{x:0,y:0},k.mult(a,10))},a.prototype.shoot=function(){return Date.now()-this._lastShoot>=2e3?(new i(this),this._lastShoot=Date.now()):void 0},a.prototype.destroy=function(){return this._isAlive=!1,delete d.tanks[this.body.id],console.log(this.body.label+" was destroyed!")},a.prototype.lives=100,a.prototype._isAlive=!0,a.prototype._lastShoot=Date.now(),a}(),g=function(a){function b(a,c){b.__super__.constructor.call(this,a,c,"player"),this.enable.keyboard(this),this.enable.mouse(this)}return q(b,a),b.prototype.enable={keyboard:function(a){return Mousetrap.bind(["w","up"],function(){return a.move(k.fromAngle(a.body.angle))}),Mousetrap.bind(["s","down"],function(){return a.move(k.neg(k.fromAngle(a.body.angle)))}),Mousetrap.bind(["a","left"],function(){return Matter.Body.rotate(a.body,Math.degreesToRadians(-2))}),Mousetrap.bind(["d","right"],function(){return Matter.Body.rotate(a.body,Math.degreesToRadians(2))})},mouse:function(a){return window.onmousemove=function(b){return f.position={x:b.x,y:b.y},a.body.render.tank.children[1].rotation=a.body.turretRotation=Math.atan2(h.size.y/2-b.y,h.size.x/2-b.x)-Math.PI/2},window.onclick=function(){return a.shoot()}}},b.prototype.disable={keyboard:function(){return Mousetrap.unbind(["w","up","s","down","a","left","d","right"])},mouse:function(){return window.onmousemove=window.onclick=null}},b.prototype.destroy=function(){return this.disable.keyboard(),this.disable.mouse(),b.__super__.destroy.apply(this,arguments)},b}(j),Matter.Engine.run(c),b.debug===!1&&(l={pixel:new PIXI.PixelateFilter},l.pixel.size={x:3,y:3},c.render.spriteBatch.filters=[l.pixel]),e.generate(),m=o=0;100>=o;m=++o)new j(Math.randomInt(0,h.size.x),Math.randomInt(0,h.size.y),"bot");n=new g(h.size.x/2,h.size.y/2),a.followPlayer(n),Matter.Events.on(c,"tick",function(){var a,d,e,f;for(a=Matter.Composite.allBodies(c.world),e=0,f=a.length;f>e;e++)d=a[e],d.label.contains("shell")&&d.isSleeping&&Matter.Composite.remove(c.world,d);return b.debug?window.engine=c:void 0})}).call(this);